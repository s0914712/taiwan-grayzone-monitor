<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±è¨ˆåˆ†æ | Taiwan Gray Zone Monitor</title>
    <meta name="description" content="å°ç£å‘¨é‚Šæµ·åŸŸèˆ¹éš»æ´»å‹•çµ±è¨ˆåˆ†æèˆ‡è»æ¼”é æ¸¬æŒ‡æ¨™">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&family=Orbitron:wght@400;700;900&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/main.css">

    <style>
        body {
            overflow-y: auto;
        }

        .time-range-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .time-range-btn {
            padding: 6px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-glow);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-range-btn:hover,
        .time-range-btn.active {
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
            background: rgba(0, 245, 255, 0.1);
        }

        .prediction-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .prediction-level {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 700;
        }

        .prediction-level.low {
            color: var(--accent-green);
        }

        .prediction-level.medium {
            color: var(--accent-yellow);
        }

        .prediction-level.high {
            color: var(--accent-orange);
        }

        .prediction-level.critical {
            color: var(--accent-red);
        }

        .prediction-details {
            flex: 1;
        }

        .prediction-title {
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .prediction-desc {
            font-size: 9px;
            color: var(--text-secondary);
        }

        .correlation-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .correlation-item {
            background: var(--bg-card);
            border-radius: 4px;
            padding: 10px;
            text-align: center;
        }

        .correlation-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 700;
        }

        .correlation-positive {
            color: var(--accent-red);
        }

        .correlation-negative {
            color: var(--accent-green);
        }

        .correlation-neutral {
            color: var(--text-secondary);
        }

        .correlation-label {
            font-size: 8px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
    </style>
</head>

<body>
    <header class="header">
        <h1>ğŸ“Š çµ±è¨ˆåˆ†æ Statistics</h1>
        <div class="header-nav">
            <a href="index.html">ç°è‰²åœ°å¸¶ç›£æ¸¬</a>
            <a href="dark-vessels.html">æš—èˆ¹åµæ¸¬</a>
            <a href="statistics.html" class="active">çµ±è¨ˆåˆ†æ</a>
            <span class="data-status" id="dataStatus">è¼‰å…¥ä¸­...</span>
        </div>
    </header>

    <!-- æ™‚é–“ç¯„åœé¸æ“‡ -->
    <div style="padding: 10px 16px;">
        <div class="time-range-selector">
            <button class="time-range-btn" data-range="7">7 å¤©</button>
            <button class="time-range-btn active" data-range="30">30 å¤©</button>
            <button class="time-range-btn" data-range="90">90 å¤©</button>
        </div>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="value" id="statTotalDark">--</div>
            <div class="label">æš—èˆ¹ç¸½æ•¸</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statAvgDaily">--</div>
            <div class="label">æ—¥å‡æš—èˆ¹</div>
        </div>
        <div class="stat-card">
            <div class="value alert" id="statDarkRatio">--%</div>
            <div class="label">æš—èˆ¹æ¯”ä¾‹</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statChnHours">--</div>
            <div class="label">ä¸­åœ‹èˆ¹æ™‚(è¬)</div>
        </div>
    </div>

    <div class="main-content">
        <!-- è»æ¼”é æ¸¬æŒ‡æ¨™ -->
        <div class="panel" style="grid-column: 1 / -1;">
            <div class="panel-title">ğŸ¯ è»æ¼”é æ¸¬æŒ‡æ¨™</div>
            <div class="panel-body">
                <div class="prediction-indicator">
                    <div class="prediction-level medium" id="predictionLevel">ä¸­</div>
                    <div class="prediction-details">
                        <div class="prediction-title">7æ—¥é æ¸¬é¢¨éšªç­‰ç´š</div>
                        <div class="prediction-desc" id="predictionDesc">æš—èˆ¹æ´»å‹•ç•¥é«˜æ–¼å¹³å‡ï¼ŒæŒçºŒè§€å¯Ÿä¸­</div>
                    </div>
                </div>
                <div class="correlation-grid">
                    <div class="correlation-item">
                        <div class="correlation-value correlation-positive" id="corrLag1">+0.42</div>
                        <div class="correlation-label">æš—èˆ¹â†’æ¶æ¬¡ (1æ—¥æ»¯å¾Œ)</div>
                    </div>
                    <div class="correlation-item">
                        <div class="correlation-value correlation-positive" id="corrLag3">+0.38</div>
                        <div class="correlation-label">æš—èˆ¹â†’æ¶æ¬¡ (3æ—¥æ»¯å¾Œ)</div>
                    </div>
                    <div class="correlation-item">
                        <div class="correlation-value correlation-positive" id="corrLag7">+0.29</div>
                        <div class="correlation-label">æš—èˆ¹â†’æ¶æ¬¡ (7æ—¥æ»¯å¾Œ)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¶¨å‹¢åœ– -->
        <div class="panel chart-panel">
            <div class="panel-title">ğŸ“ˆ æš—èˆ¹æ•¸é‡è¶¨å‹¢</div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- å€åŸŸå°æ¯”åœ– -->
        <div class="panel">
            <div class="panel-title">ğŸ—ºï¸ å€åŸŸæš—èˆ¹åˆ†å¸ƒ</div>
            <div class="chart-container" style="height: 200px;">
                <canvas id="regionChart"></canvas>
            </div>
        </div>

        <!-- åœ‹æ——åˆ†å¸ƒåœ– -->
        <div class="panel">
            <div class="panel-title">ğŸš© æœ‰ AIS èˆ¹éš»åœ‹æ——åˆ†å¸ƒ</div>
            <div class="chart-container" style="height: 200px;">
                <canvas id="flagChart"></canvas>
            </div>
        </div>

        <!-- æ¯æ—¥è©³ç´°æ•¸æ“šè¡¨ -->
        <div class="panel" style="grid-column: 1 / -1;">
            <div class="panel-title">ğŸ“‹ æ¯æ—¥æ•¸æ“š</div>
            <div class="panel-body">
                <table class="region-table" id="dailyTable">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>SAR åµæ¸¬</th>
                            <th>æš—èˆ¹</th>
                            <th>æš—èˆ¹æ¯”ä¾‹</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="dailyTableBody">
                        <tr>
                            <td colspan="5" class="empty-state">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="update-info" id="updateInfo">è³‡æ–™æ›´æ–°æ™‚é–“: --</div>

    <!-- JavaScript -->
    <script src="js/charts.js"></script>
    <script>
        let fullData = null;
        let selectedRange = 30;

        async function loadData() {
            try {
                const res = await fetch('data.json?' + Date.now());
                fullData = await res.json();

                document.getElementById('dataStatus').textContent = 'âœ… è³‡æ–™å·²è¼‰å…¥';
                document.getElementById('updateInfo').textContent =
                    'æ›´æ–°: ' + new Date(fullData.updated_at).toLocaleString('zh-TW');

                renderStats();
                renderCharts();
                renderDailyTable();
                renderPrediction();
            } catch (e) {
                console.error('è¼‰å…¥å¤±æ•—:', e);
                document.getElementById('dataStatus').textContent = 'âŒ è³‡æ–™è¼‰å…¥å¤±æ•—';
            }
        }

        function renderStats() {
            if (!fullData.dark_vessels || !fullData.dark_vessels.overall) return;

            const overall = fullData.dark_vessels.overall;
            document.getElementById('statTotalDark').textContent =
                ChartsModule.formatCompact(overall.dark_vessels || 0);
            document.getElementById('statAvgDaily').textContent =
                Math.round((overall.dark_vessels || 0) / Math.max(1, selectedRange));
            document.getElementById('statDarkRatio').textContent =
                (overall.dark_ratio || 0) + '%';

            if (fullData.vessel_monitoring && fullData.vessel_monitoring.summary) {
                const s = fullData.vessel_monitoring.summary;
                document.getElementById('statChnHours').textContent =
                    (s.chn_presence_hours / 10000).toFixed(1);
            }
        }

        function renderCharts() {
            // Trend chart
            if (fullData.vessel_monitoring && fullData.vessel_monitoring.daily) {
                const daily = fullData.vessel_monitoring.daily.slice(-selectedRange);
                const labels = daily.map(d => d.date.slice(5));
                const darkData = daily.map(d => d.dark_vessels);
                const totalData = daily.map(d => d.total_detections);

                ChartsModule.renderTrendChart('trendChart', {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æš—èˆ¹',
                            data: darkData,
                            borderColor: '#ff3366',
                            backgroundColor: 'rgba(255, 51, 102, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'SAR ç¸½åµæ¸¬',
                            data: totalData,
                            borderColor: '#00f5ff',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.3
                        }
                    ]
                });
            }

            // Region chart
            if (fullData.dark_vessels && fullData.dark_vessels.regions) {
                const regions = fullData.dark_vessels.regions;
                const labels = [];
                const values = [];
                const colors = ['#00f5ff', '#ff6b35', '#00ff88', '#ffd700'];

                Object.entries(regions).forEach(([key, r], i) => {
                    labels.push(r.name || key);
                    values.push(r.dark_vessels || 0);
                });

                ChartsModule.renderPieChart('regionChart', labels, values, colors);
            }

            // Flag chart
            if (fullData.dark_vessels && fullData.dark_vessels.regions &&
                fullData.dark_vessels.regions.taiwan_strait &&
                fullData.dark_vessels.regions.taiwan_strait.matched_by_flag) {

                const flags = fullData.dark_vessels.regions.taiwan_strait.matched_by_flag;
                const entries = Object.entries(flags).slice(0, 6);
                const labels = entries.map(([k]) => k);
                const values = entries.map(([, v]) => v);
                const colors = ['#ff3366', '#00f5ff', '#ff6b35', '#00ff88', '#ffd700', '#9b59b6'];

                ChartsModule.renderPieChart('flagChart', labels, values, colors);
            }
        }

        function renderDailyTable() {
            const tbody = document.getElementById('dailyTableBody');
            if (!fullData.vessel_monitoring || !fullData.vessel_monitoring.daily) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">ç„¡è³‡æ–™</td></tr>';
                return;
            }

            const daily = fullData.vessel_monitoring.daily.slice(-selectedRange).reverse();

            tbody.innerHTML = daily.map(d => {
                const ratio = d.total_detections > 0
                    ? Math.round(d.dark_vessels / d.total_detections * 100)
                    : 0;
                const barWidth = Math.max(2, Math.min(100, ratio));

                return `
                    <tr>
                        <td>${d.date}</td>
                        <td>${d.total_detections}</td>
                        <td style="color:var(--accent-red);font-weight:600">${d.dark_vessels}</td>
                        <td>${ratio}%</td>
                        <td><span class="ratio-bar" style="width:${barWidth}px"></span></td>
                    </tr>
                `;
            }).join('');
        }

        function renderPrediction() {
            if (!fullData.exercise_prediction) return;

            const pred = fullData.exercise_prediction;

            // Update correlation values if available
            if (pred.lag_correlation) {
                const lags = pred.lag_correlation;
                // Find correlations for lag 1, 3, 7
                lags.forEach(l => {
                    if (l.lag === 1) updateCorrelation('corrLag1', l.correlation);
                    if (l.lag === 3) updateCorrelation('corrLag3', l.correlation);
                    if (l.lag === 7) updateCorrelation('corrLag7', l.correlation);
                });
            }

            // Update prediction level based on recent trends
            if (pred.high_sortie_analysis) {
                const analysis = pred.high_sortie_analysis;
                const levelEl = document.getElementById('predictionLevel');
                const descEl = document.getElementById('predictionDesc');

                if (analysis.avg_dark_before_high > analysis.overall_avg_dark * 1.5) {
                    levelEl.textContent = 'é«˜';
                    levelEl.className = 'prediction-level high';
                    descEl.textContent = 'æš—èˆ¹æ´»å‹•é¡¯è‘—é«˜æ–¼å¹³å‡ï¼Œéœ€å¯†åˆ‡é—œæ³¨';
                } else if (analysis.avg_dark_before_high > analysis.overall_avg_dark * 1.2) {
                    levelEl.textContent = 'ä¸­';
                    levelEl.className = 'prediction-level medium';
                    descEl.textContent = 'æš—èˆ¹æ´»å‹•ç•¥é«˜æ–¼å¹³å‡ï¼ŒæŒçºŒè§€å¯Ÿä¸­';
                } else {
                    levelEl.textContent = 'ä½';
                    levelEl.className = 'prediction-level low';
                    descEl.textContent = 'æš—èˆ¹æ´»å‹•è™•æ–¼æ­£å¸¸ç¯„åœ';
                }
            }
        }

        function updateCorrelation(elId, value) {
            const el = document.getElementById(elId);
            if (!el) return;

            el.textContent = (value > 0 ? '+' : '') + value.toFixed(2);
            el.className = 'correlation-value ' +
                (value > 0.2 ? 'correlation-positive' :
                    value < -0.2 ? 'correlation-negative' : 'correlation-neutral');
        }

        // Time range selector
        document.querySelectorAll('.time-range-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedRange = parseInt(btn.dataset.range);
                renderStats();
                renderCharts();
                renderDailyTable();
            });
        });

        // Initialize
        loadData();
    </script>
</body>

</html>