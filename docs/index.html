<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£ç°è‰²åœ°å¸¶ç›£æ¸¬ | Taiwan Gray Zone Monitor</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #141e32;
            --bg-card: rgba(25, 35, 60, 0.95);
            --text-primary: #e8eef7;
            --text-secondary: #8aa4c8;
            --accent-cyan: #00f5ff;
            --accent-orange: #ff6b35;
            --accent-red: #ff3366;
            --accent-green: #00ff88;
            --accent-yellow: #ffd700;
            --accent-purple: #9b59b6;
            --border-glow: rgba(0, 245, 255, 0.3);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            grid-template-rows: auto 1fr;
            height: 100vh;
        }
        
        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { display: none; }
        }
        
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-glow);
        }
        
        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 900;
            letter-spacing: 1px;
            color: var(--accent-cyan);
            text-shadow: 0 0 15px rgba(0, 245, 255, 0.5);
        }
        
        .header-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .data-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            color: var(--text-secondary);
            padding: 4px 10px;
            background: var(--bg-card);
            border-radius: 4px;
            border: 1px solid var(--border-glow);
        }
        
        .data-status.live {
            color: var(--accent-green);
            border-color: var(--accent-green);
        }
        
        .map-section { position: relative; }
        #map { width: 100%; height: 100%; background: #0a1628; }
        
        .map-overlay {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .overlay-card {
            background: var(--bg-card);
            border: 1px solid var(--border-glow);
            border-radius: 5px;
            padding: 6px 10px;
            backdrop-filter: blur(10px);
            min-width: 95px;
        }
        
        .overlay-card .label { font-size: 8px; color: var(--text-secondary); text-transform: uppercase; }
        .overlay-card .value { font-family: 'Orbitron', sans-serif; font-size: 18px; font-weight: 700; color: var(--accent-cyan); }
        .overlay-card.alert .value { color: var(--accent-red); }
        
        .map-legend {
            position: absolute;
            bottom: 15px;
            left: 8px;
            z-index: 1000;
            background: var(--bg-card);
            border: 1px solid var(--border-glow);
            border-radius: 5px;
            padding: 8px 10px;
            font-size: 8px;
        }
        
        .legend-section { margin-bottom: 6px; }
        .legend-title { font-size: 7px; color: var(--text-secondary); margin-bottom: 3px; text-transform: uppercase; }
        .legend-item { display: flex; align-items: center; gap: 4px; margin: 2px 0; }
        .legend-dot { width: 7px; height: 7px; border-radius: 50%; }
        .legend-line { width: 14px; height: 2px; border-radius: 1px; }
        
        .layer-toggles {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 1000;
            background: var(--bg-card);
            border: 1px solid var(--border-glow);
            border-radius: 5px;
            padding: 6px 8px;
        }
        
        .layer-toggle { display: flex; align-items: center; gap: 5px; margin: 3px 0; cursor: pointer; font-size: 9px; }
        .layer-toggle input { width: 12px; height: 12px; accent-color: var(--accent-cyan); }
        
        .sidebar {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-glow);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-section { padding: 10px; border-bottom: 1px solid rgba(0, 245, 255, 0.1); }
        .section-title { font-size: 10px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
        .stat-box { background: var(--bg-card); border-radius: 4px; padding: 6px; text-align: center; }
        .stat-box .value { font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: 700; color: var(--accent-cyan); }
        .stat-box .label { font-size: 7px; color: var(--text-secondary); margin-top: 1px; }
        
        .suspicious-list { max-height: 150px; overflow-y: auto; }
        .suspicious-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 5px;
            margin: 2px 0;
            background: rgba(255, 51, 102, 0.1);
            border-radius: 3px;
            font-size: 8px;
            cursor: pointer;
            transition: background 0.15s;
            border-left: 2px solid var(--accent-red);
        }
        .suspicious-item:hover { background: rgba(255, 51, 102, 0.25); }
        .suspicious-item .risk-badge {
            font-size: 6px;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .risk-critical { background: var(--accent-red); color: #fff; }
        .risk-high { background: var(--accent-orange); color: #fff; }
        .risk-medium { background: var(--accent-yellow); color: #000; }

        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        .vessel-list { max-height: 130px; overflow-y: auto; }
        .vessel-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 5px;
            margin: 2px 0;
            background: var(--bg-card);
            border-radius: 3px;
            font-size: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .vessel-item:hover { background: rgba(0, 245, 255, 0.15); }
        
        .zone-list { }
        .zone-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 6px;
            margin: 2px 0;
            background: var(--bg-card);
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
        }
        .zone-item:hover { background: rgba(0, 245, 255, 0.15); }
        .zone-count { font-family: 'Orbitron', sans-serif; font-weight: 700; }
        
        .update-info {
            padding: 8px 10px;
            background: var(--bg-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: auto;
        }
        
        .leaflet-popup-content-wrapper { background: var(--bg-card); color: var(--text-primary); border-radius: 5px; border: 1px solid var(--border-glow); }
        .leaflet-popup-tip { background: var(--bg-card); }
        .leaflet-popup-content { margin: 6px 8px; font-size: 9px; line-height: 1.4; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>ğŸ›°ï¸ å°ç£ç°è‰²åœ°å¸¶ç›£æ¸¬</h1>
            <div class="header-info">
                <div class="data-status" id="dataStatus">â³ è¼‰å…¥ä¸­...</div>
            </div>
        </header>
        
        <div class="map-section">
            <div id="map"></div>
            
            <div class="map-overlay">
                <div class="overlay-card">
                    <div class="label">èˆ¹éš»æ•¸</div>
                    <div class="value" id="vesselCount">0</div>
                </div>
                <div class="overlay-card">
                    <div class="label">è»æ¼”å€</div>
                    <div class="value" id="drillZoneCount">0</div>
                </div>
                <div class="overlay-card alert">
                    <div class="label">å¯ç–‘èˆ¹éš»</div>
                    <div class="value" id="suspiciousCount">0</div>
                </div>
            </div>
            
            <div class="layer-toggles">
                <label class="layer-toggle"><input type="checkbox" id="showDrillZones" checked onchange="toggleLayer('drillZones')"> è»æ¼”å€åŸŸ</label>
                <label class="layer-toggle"><input type="checkbox" id="showFishingHotspots" checked onchange="toggleLayer('fishingHotspots')"> æ¼æ’ˆç†±é»</label>
                <label class="layer-toggle"><input type="checkbox" id="showVessels" checked onchange="toggleLayer('vessels')"> èˆ¹éš»</label>
            </div>
            
            <div class="map-legend">
                <div class="legend-section">
                    <div class="legend-title">èˆ¹éš»é¡å‹</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#00ff88"></div> æ¼èˆ¹</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#00f5ff"></div> è²¨èˆ¹</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ff6b35"></div> æ²¹è¼ª</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ff3366"></div> å…¶ä»–</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ff3366;box-shadow:0 0 6px #ff3366"></div> å¯ç–‘</div>
                </div>
                <div class="legend-section">
                    <div class="legend-title">å€åŸŸ</div>
                    <div class="legend-item"><div class="legend-line" style="background:rgba(0,255,136,0.4)"></div> æ¼æ’ˆç†±é»</div>
                </div>
            </div>
        </div>
        
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="section-title">ğŸ“Š çµ±è¨ˆæ•¸æ“š</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="statTotal">0</div>
                        <div class="label">ç¸½èˆ¹éš»</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="statFishing">0</div>
                        <div class="label">æ¼èˆ¹</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="statCargo">0</div>
                        <div class="label">è²¨èˆ¹</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="statTanker">0</div>
                        <div class="label">æ²¹è¼ª</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="section-title">ğŸ” å¯ç–‘èˆ¹éš» (CSIS æ–¹æ³•è«–)</div>
                <div class="suspicious-list" id="suspiciousList">
                    <div style="font-size:8px;color:var(--text-secondary);padding:4px">ç´¯ç©è§€æ¸¬è³‡æ–™ä¸­...</div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">âš ï¸ è»æ¼”ç›£æ¸¬å€</div>
                <div class="zone-list" id="zoneList"></div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">ğŸš¢ è¿‘æœŸèˆ¹éš»</div>
                <div class="vessel-list" id="vesselList"></div>
            </div>
            
            <div class="update-info" id="updateInfo">
                è³‡æ–™æ›´æ–°æ™‚é–“: --
            </div>
        </aside>
    </div>
    
    <script>
        // =============================================
        // å…¨åŸŸè¨­å®š
        // =============================================
        
        let map;
        let layers = { drillZones: null, fishingHotspots: null, vessels: null };
        let vessels = new Map();
        let vesselMarkers = {};
        let suspiciousData = null;

        // è»æ¼”ç›£æ¸¬å€
        const DRILL_ZONES = {
            north: { name: 'åŒ—éƒ¨æµ·åŸŸ', color: '#00f5ff', coords: [[25.5, 121.0], [25.5, 122.5], [26.8, 122.5], [26.8, 121.0]] },
            east: { name: 'æ±éƒ¨æµ·åŸŸ', color: '#ff6b35', coords: [[23.0, 122.5], [23.0, 125.0], [25.5, 125.0], [25.5, 122.5]] },
            south: { name: 'å—éƒ¨æµ·åŸŸ', color: '#00ff88', coords: [[21.5, 119.0], [21.5, 121.0], [23.0, 121.0], [23.0, 119.0]] },
            west: { name: 'è¥¿éƒ¨æµ·åŸŸ', color: '#ffd700', coords: [[23.5, 118.5], [23.5, 120.0], [25.0, 120.0], [25.0, 118.5]] }
        };
        
        const VESSEL_COLORS = {
            fishing: '#00ff88',
            cargo: '#00f5ff',
            tanker: '#ff6b35',
            other: '#ff3366',
            unknown: '#888888'
        };

        // æ¼æ’ˆç†±é»ï¼ˆå°æ‡‰å¾Œç«¯ FISHING_HOTSPOTSï¼‰
        const FISHING_HOTSPOTS = {
            taiwan_bank: { name: 'å°ç£ç˜æ¼å ´', coords: [[22.0, 117.0], [22.0, 119.5], [23.5, 119.5], [23.5, 117.0]], color: 'rgba(0,255,136,0.15)' },
            penghu: { name: 'æ¾æ¹–æ¼å ´', coords: [[23.0, 119.0], [23.0, 120.0], [24.0, 120.0], [24.0, 119.0]], color: 'rgba(0,255,136,0.15)' },
            kuroshio_east: { name: 'æ±éƒ¨é»‘æ½®æ¼å ´', coords: [[22.5, 121.0], [22.5, 122.0], [24.5, 122.0], [24.5, 121.0]], color: 'rgba(0,255,136,0.15)' },
            northeast: { name: 'æ±åŒ—æ¼å ´', coords: [[24.8, 121.5], [24.8, 123.0], [25.8, 123.0], [25.8, 121.5]], color: 'rgba(0,255,136,0.15)' },
            southwest: { name: 'è¥¿å—æ²¿å²¸æ¼å ´', coords: [[22.0, 120.0], [22.0, 120.8], [23.0, 120.8], [23.0, 120.0]], color: 'rgba(0,255,136,0.15)' },
        };

        // =============================================
        // åˆå§‹åŒ–
        // =============================================
        
        function initMap() {
            map = L.map('map', { 
                center: [24.0, 121.0], 
                zoom: 7, 
                zoomControl: true, 
                attributionControl: false 
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
                maxZoom: 18, 
                opacity: 0.9 
            }).addTo(map);
            
            // å»ºç«‹åœ–å±¤
            layers.drillZones = L.layerGroup().addTo(map);
            layers.fishingHotspots = L.layerGroup().addTo(map);
            layers.vessels = L.layerGroup().addTo(map);
            
            // ç¹ªè£½å°ç£æœ¬å³¶è¼ªå»“
            const taiwanOutline = [
                [25.3, 121.0], [25.13, 121.5], [24.85, 121.82], [24.5, 121.8], 
                [24.0, 121.5], [23.5, 121.3], [23.0, 121.0], [22.5, 120.85],
                [22.0, 120.75], [21.9, 120.85], [22.0, 120.45], [22.3, 120.25],
                [22.6, 120.3], [23.0, 120.1], [23.5, 120.05], [24.0, 120.2],
                [24.5, 120.5], [25.0, 121.0], [25.3, 121.0]
            ];
            L.polygon(taiwanOutline, { 
                color: '#4a90d9', 
                weight: 2, 
                opacity: 0.5, 
                fillColor: '#1a3a5c',
                fillOpacity: 0.3
            }).addTo(map);
            
            // ç¹ªè£½å„åœ–å±¤
            drawDrillZones();
            drawFishingHotspots();
            updateZoneList();
            
            // è¼‰å…¥è³‡æ–™
            loadData();
        }
        
        // =============================================
        // ç¹ªè£½åœ–å±¤
        // =============================================
        
        function drawDrillZones() {
            layers.drillZones.clearLayers();

            Object.entries(DRILL_ZONES).forEach(([key, zone]) => {
                const polygon = L.polygon(zone.coords, {
                    color: zone.color,
                    weight: 2,
                    opacity: 0.6,
                    fillColor: zone.color,
                    fillOpacity: 0.08,
                    dashArray: '6, 4'
                }).addTo(layers.drillZones);

                polygon.bindTooltip(zone.name, { permanent: false, direction: 'center' });
                polygon.on('click', () => map.flyToBounds(zone.coords, { padding: [30, 30] }));
            });
        }

        function drawFishingHotspots() {
            layers.fishingHotspots.clearLayers();

            Object.entries(FISHING_HOTSPOTS).forEach(([key, hotspot]) => {
                const polygon = L.polygon(hotspot.coords, {
                    color: '#00ff88',
                    weight: 1,
                    opacity: 0.4,
                    fillColor: '#00ff88',
                    fillOpacity: 0.06,
                    dashArray: '3, 6'
                }).addTo(layers.fishingHotspots);

                polygon.bindTooltip(hotspot.name, { permanent: false, direction: 'center' });
            });
        }

        // =============================================
        // å´é‚Šæ¬„æ›´æ–°
        // =============================================

        function updateZoneList() {
            const list = document.getElementById('zoneList');
            list.innerHTML = Object.entries(DRILL_ZONES).map(([key, zone]) => `
                <div class="zone-item" onclick="focusZone('${key}')" style="border-left: 3px solid ${zone.color}">
                    <span>${zone.name}</span>
                    <span class="zone-count" id="zone-${key}" style="color:${zone.color}">0</span>
                </div>
            `).join('');
        }
        
        function updateVesselList() {
            const list = document.getElementById('vesselList');
            const recent = Array.from(vessels.values()).slice(0, 12);
            
            list.innerHTML = recent.map(v => `
                <div class="vessel-item" onclick="focusVessel('${v.mmsi}')">
                    <span style="color:${VESSEL_COLORS[v.type_name] || VESSEL_COLORS.other}">${(v.name || 'Unknown').substring(0, 14)}</span>
                    <span style="font-size:7px;color:var(--text-secondary)">${v.type_name || 'æœªçŸ¥'}</span>
                </div>
            `).join('');
        }
        
        // =============================================
        // ç„¦é»åŠŸèƒ½
        // =============================================
        
        function focusZone(key) {
            const zone = DRILL_ZONES[key];
            if (zone) {
                map.flyToBounds(zone.coords, { padding: [30, 30] });
            }
        }
        
        function focusVessel(mmsi) {
            const v = vessels.get(mmsi);
            if (v && vesselMarkers[mmsi]) {
                map.flyTo([v.lat, v.lon], 10);
                vesselMarkers[mmsi].openPopup();
            }
        }
        
        function toggleLayer(name) {
            const checkbox = document.getElementById('show' + name.charAt(0).toUpperCase() + name.slice(1));
            if (checkbox.checked) {
                map.addLayer(layers[name]);
            } else {
                map.removeLayer(layers[name]);
            }
        }
        
        // =============================================
        // è³‡æ–™è¼‰å…¥
        // =============================================
        
        async function loadData() {
            try {
                const res = await fetch('data.json?' + Date.now());
                const data = await res.json();

                // è¼‰å…¥ CSIS å¯ç–‘èˆ¹éš»åˆ†æçµæœ
                if (data.suspicious_analysis) {
                    suspiciousData = data.suspicious_analysis;
                    updateSuspiciousList();
                }

                if (data.ais_snapshot && data.ais_snapshot.vessels && data.ais_snapshot.vessels.length > 0) {
                    displayVessels(data.ais_snapshot.vessels);
                    const updateTime = new Date(data.updated_at).toLocaleString('zh-TW');
                    document.getElementById('updateInfo').textContent = 'æ›´æ–°: ' + updateTime;
                    document.getElementById('dataStatus').textContent = 'âœ… AIS è³‡æ–™å·²è¼‰å…¥';
                    document.getElementById('dataStatus').classList.add('live');
                } else {
                    document.getElementById('dataStatus').textContent = 'âš ï¸ å°šç„¡ AIS è³‡æ–™';
                    document.getElementById('updateInfo').textContent = 'ç­‰å¾… API è³‡æ–™æ”¶é›†...';
                }
            } catch (e) {
                console.log('è¼‰å…¥ data.json å¤±æ•—:', e);
                document.getElementById('dataStatus').textContent = 'âŒ è³‡æ–™è¼‰å…¥å¤±æ•—';
                document.getElementById('updateInfo').textContent = 'è«‹ç¢ºèª data.json æ˜¯å¦å­˜åœ¨';
            }
        }
        
        function displayVessels(vesselList) {
            layers.vessels.clearLayers();
            vessels.clear();
            vesselMarkers = {};

            let stats = { total: 0, fishing: 0, cargo: 0, tanker: 0, inZone: 0, suspicious: 0 };
            let zoneCounts = { north: 0, east: 0, south: 0, west: 0 };

            vesselList.forEach(v => {
                vessels.set(v.mmsi, v);
                stats.total++;

                const isSuspicious = v.suspicious;
                const color = isSuspicious ? '#ff3366' : (VESSEL_COLORS[v.type_name] || VESSEL_COLORS.other);

                // å¯ç–‘èˆ¹éš»åŠ å¤§ä¸¦åŠ ç™¼å…‰æ•ˆæœ
                if (isSuspicious) {
                    stats.suspicious++;
                    // å¤–åœˆè„ˆè¡å…‰ç’°
                    L.circleMarker([v.lat, v.lon], {
                        radius: 12,
                        fillColor: '#ff3366',
                        color: '#ff3366',
                        weight: 1,
                        opacity: 0.3,
                        fillOpacity: 0.15
                    }).addTo(layers.vessels);
                }

                const marker = L.circleMarker([v.lat, v.lon], {
                    radius: isSuspicious ? 6 : 4,
                    fillColor: color,
                    color: isSuspicious ? '#ffffff' : color,
                    weight: isSuspicious ? 2 : 1,
                    opacity: 0.9,
                    fillOpacity: isSuspicious ? 1 : 0.7
                }).addTo(layers.vessels);

                const suspiciousInfo = isSuspicious
                    ? '<br><b style="color:#ff3366">CSIS å¯ç–‘ï¼šæ¼èˆ¹åœ¨è»æ¼”å€ä½†ä¸åœ¨æ¼å ´</b>'
                    : '';

                marker.bindPopup(`
                    <b>${v.name || 'Unknown'}</b><br>
                    MMSI: ${v.mmsi}<br>
                    é¡å‹: ${v.type_name || 'æœªçŸ¥'}<br>
                    èˆªé€Ÿ: ${(v.speed || 0).toFixed(1)} kn${suspiciousInfo}
                `);

                vesselMarkers[v.mmsi] = marker;

                // çµ±è¨ˆ
                if (v.type_name === 'fishing') stats.fishing++;
                if (v.type_name === 'cargo') stats.cargo++;
                if (v.type_name === 'tanker') stats.tanker++;

                const zone = v.in_drill_zone || getZoneForPosition(v.lat, v.lon);
                if (zone) {
                    stats.inZone++;
                    zoneCounts[zone]++;
                }
            });

            // æ›´æ–° UI
            document.getElementById('vesselCount').textContent = stats.total;
            document.getElementById('drillZoneCount').textContent = stats.inZone;
            document.getElementById('suspiciousCount').textContent =
                (suspiciousData && suspiciousData.summary)
                    ? suspiciousData.summary.suspicious_count
                    : stats.suspicious;
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statFishing').textContent = stats.fishing;
            document.getElementById('statCargo').textContent = stats.cargo;
            document.getElementById('statTanker').textContent = stats.tanker;

            // æ›´æ–°å€åŸŸè¨ˆæ•¸
            Object.keys(zoneCounts).forEach(key => {
                const el = document.getElementById('zone-' + key);
                if (el) el.textContent = zoneCounts[key];
            });

            updateVesselList();
        }
        
        function getZoneForPosition(lat, lon) {
            for (const [key, zone] of Object.entries(DRILL_ZONES)) {
                const [sw, , ne] = [zone.coords[0], zone.coords[1], zone.coords[2]];
                const minLat = Math.min(sw[0], ne[0]);
                const maxLat = Math.max(sw[0], ne[0]);
                const minLon = Math.min(sw[1], ne[1]);
                const maxLon = Math.max(sw[1], ne[1]);

                if (lat >= minLat && lat <= maxLat && lon >= minLon && lon <= maxLon) {
                    return key;
                }
            }
            return null;
        }

        function getFishingHotspot(lat, lon) {
            for (const [key, hotspot] of Object.entries(FISHING_HOTSPOTS)) {
                const [sw, , ne] = [hotspot.coords[0], hotspot.coords[1], hotspot.coords[2]];
                const minLat = Math.min(sw[0], ne[0]);
                const maxLat = Math.max(sw[0], ne[0]);
                const minLon = Math.min(sw[1], ne[1]);
                const maxLon = Math.max(sw[1], ne[1]);

                if (lat >= minLat && lat <= maxLat && lon >= minLon && lon <= maxLon) {
                    return key;
                }
            }
            return null;
        }

        function updateSuspiciousList() {
            const list = document.getElementById('suspiciousList');
            if (!suspiciousData || !suspiciousData.suspicious_vessels || suspiciousData.suspicious_vessels.length === 0) {
                const summary = suspiciousData && suspiciousData.summary;
                if (summary && summary.total_analyzed > 0) {
                    list.innerHTML = `<div style="font-size:8px;color:var(--text-secondary);padding:4px">
                        å·²åˆ†æ ${summary.total_analyzed} è‰˜ï¼Œæš«ç„¡é”åˆ°é–€æª»çš„å¯ç–‘èˆ¹éš»</div>`;
                }
                return;
            }

            const riskColors = { critical: '#ff3366', high: '#ff6b35', medium: '#ffd700' };

            list.innerHTML = suspiciousData.suspicious_vessels.slice(0, 10).map(sv => {
                const name = (sv.names && sv.names[0]) || sv.mmsi;
                const riskClass = 'risk-' + sv.risk_level;
                const flags = (sv.flags || []).slice(0, 2).join('ã€');

                return `
                    <div class="suspicious-item" onclick="focusSuspicious(${sv.last_lat}, ${sv.last_lon})">
                        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                            ${name.substring(0, 12)}
                        </span>
                        <span class="risk-badge ${riskClass}">${sv.risk_level}</span>
                    </div>`;
            }).join('');

            // åœ¨åœ°åœ–ä¸Šæ¨™è¨˜ CSIS åˆ†æå‡ºçš„å¯ç–‘èˆ¹éš»
            if (suspiciousData.suspicious_vessels) {
                suspiciousData.suspicious_vessels.forEach(sv => {
                    if (sv.last_lat && sv.last_lon) {
                        L.circleMarker([sv.last_lat, sv.last_lon], {
                            radius: 8,
                            fillColor: riskColors[sv.risk_level] || '#ff3366',
                            color: '#ffffff',
                            weight: 2,
                            opacity: 0.9,
                            fillOpacity: 0.9
                        }).addTo(layers.vessels).bindPopup(`
                            <b style="color:${riskColors[sv.risk_level] || '#ff3366'}">${(sv.names && sv.names[0]) || sv.mmsi}</b><br>
                            MMSI: ${sv.mmsi}<br>
                            <b>é¢¨éšª: ${sv.risk_level.toUpperCase()}</b> (åˆ†æ•¸: ${sv.risk_score})<br>
                            ${(sv.flags || []).map(f => '- ' + f).join('<br>')}
                        `);
                    }
                });
            }
        }

        function focusSuspicious(lat, lon) {
            if (lat && lon) map.flyTo([lat, lon], 10);
        }

        // åˆå§‹åŒ–
        initMap();
    </script>
</body>
</html>
