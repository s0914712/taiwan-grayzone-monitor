<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIS èº«åˆ†è¿½è¹¤ | Identity Tracking - Taiwan Gray Zone Monitor</title>
    <meta name="description" content="è¿½è¹¤å°ç£å‘¨é‚Šæµ·åŸŸèˆ¹éš» AIS èº«åˆ†è®Šæ›´ï¼ˆèˆ¹åã€å‘¼è™Ÿã€IMOï¼‰ï¼Œè­˜åˆ¥é »ç¹è®Šæ›´èº«åˆ†çš„å¯ç–‘èˆ¹éš»">
    <meta name="keywords" content="AIS,èº«åˆ†è®Šæ›´,èˆ¹åè®Šæ›´,å‘¼è™Ÿ,IMO,å°ç£æµ·å³½,identity change,vessel tracking,maritime surveillance">
    <meta name="author" content="Taiwan Gray Zone Monitor">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://s0914712.github.io/taiwan-grayzone-monitor/identity-history.html">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="AIS èº«åˆ†è¿½è¹¤ | Identity Tracking">
    <meta property="og:description" content="è¿½è¹¤å°ç£å‘¨é‚Šæµ·åŸŸèˆ¹éš» AIS èº«åˆ†è®Šæ›´ï¼Œè­˜åˆ¥é »ç¹è®Šæ›´èº«åˆ†çš„å¯ç–‘èˆ¹éš»">
    <meta property="og:url" content="https://s0914712.github.io/taiwan-grayzone-monitor/identity-history.html">
    <meta property="og:site_name" content="Taiwan Gray Zone Monitor">
    <meta property="og:locale" content="zh_TW">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="AIS èº«åˆ†è¿½è¹¤ | Identity Tracking">
    <meta name="twitter:description" content="è¿½è¹¤å°ç£å‘¨é‚Šæµ·åŸŸèˆ¹éš» AIS èº«åˆ†è®Šæ›´ï¼Œè­˜åˆ¥é »ç¹è®Šæ›´èº«åˆ†çš„å¯ç–‘èˆ¹éš»">

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M82X8QBL');</script>
    <!-- End Google Tag Manager -->

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&family=Orbitron:wght@400;700;900&display=swap"
        rel="stylesheet">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/main.css">

    <style>
        body { overflow-y: auto; }
        #map { height: 350px; border-radius: 0 0 6px 6px; }
        .freq-table, .timeline-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            font-family: 'JetBrains Mono', monospace;
        }
        .freq-table th, .timeline-table th {
            text-align: left;
            padding: 6px 8px;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(0,245,255,0.1);
            font-weight: 500;
            font-size: 8px;
        }
        .freq-table td, .timeline-table td {
            padding: 5px 8px;
            border-bottom: 1px solid rgba(0,245,255,0.03);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        .freq-table tr:hover, .timeline-table tr:hover {
            background: rgba(0,245,255,0.03);
        }
        .freq-table tr { cursor: pointer; }
        .change-arrow { color: var(--accent-cyan); margin: 0 2px; }
        .field-badge {
            font-size: 7px;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 600;
        }
        .field-name { background: rgba(0,245,255,0.15); color: var(--accent-cyan); }
        .field-call_sign { background: rgba(255,107,53,0.15); color: var(--accent-orange); }
        .field-imo { background: rgba(155,89,182,0.15); color: #9b59b6; }
        .timeline-scroll {
            max-height: 500px;
            overflow-y: auto;
        }
        .empty-msg {
            text-align: center;
            color: var(--text-secondary);
            padding: 24px;
            font-size: 10px;
        }
    </style>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M82X8QBL"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <header class="header">
        <h1 data-i18n="title.identity">ğŸ”„ AIS èº«åˆ†è®Šæ›´è¿½è¹¤</h1>
        <div class="header-nav">
            <a href="index.html" data-i18n="nav.grayzone">ç°è‰²åœ°å¸¶ç›£æ¸¬</a>
            <a href="dark-vessels.html" data-i18n="nav.dark_vessels">æš—èˆ¹åµæ¸¬</a>
            <a href="statistics.html" data-i18n="nav.statistics">çµ±è¨ˆåˆ†æ</a>
            <a href="weekly-animation.html" data-i18n="nav.animation">æš—èˆ¹å‹•ç•«</a>
            <a href="identity-history.html" class="active" data-i18n="nav.identity">èº«åˆ†è¿½è¹¤</a>
            <button id="langToggle" onclick="i18n.toggle()" style="font-size:9px;color:var(--accent-cyan);background:var(--bg-card);border:1px solid var(--accent-cyan);border-radius:4px;padding:3px 8px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-weight:600">EN</button>
            <span class="data-status" id="dataStatus" data-i18n="common.loading">è¼‰å…¥ä¸­...</span>
        </div>
    </header>

    <div class="stats-row">
        <div class="stat-card">
            <div class="value" id="statTotal">--</div>
            <div class="label" data-i18n="id.total_events">ç¸½äº‹ä»¶æ•¸</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statVessels">--</div>
            <div class="label" data-i18n="id.unique_vessels">æ¶‰åŠèˆ¹éš»</div>
        </div>
        <div class="stat-card">
            <div class="value alert" id="stat7d">--</div>
            <div class="label" data-i18n="id.events_7d">7 å¤©äº‹ä»¶</div>
        </div>
        <div class="stat-card">
            <div class="value alert" id="stat24h">--</div>
            <div class="label" data-i18n="id.events_24h">24h äº‹ä»¶</div>
        </div>
    </div>

    <div class="main-content">
        <div class="panel map-panel">
            <div class="panel-title" data-i18n="id.map_title">ğŸ“ èº«åˆ†è®Šæ›´ç™¼ç”Ÿä½ç½®</div>
            <div id="map"></div>
        </div>

        <div class="panel">
            <div class="panel-title" data-i18n="id.freq_title">ğŸ´ é »ç¹è®Šæ›´èˆ¹éš»æ’è¡Œ</div>
            <div class="panel-body">
                <table class="freq-table">
                    <thead>
                        <tr>
                            <th data-i18n="id.th_mmsi">MMSI</th>
                            <th data-i18n="id.th_name">ç›®å‰èˆ¹å</th>
                            <th data-i18n="id.th_changes">è®Šæ›´æ¬¡æ•¸</th>
                            <th data-i18n="id.th_last_change">æœ€è¿‘è®Šæ›´</th>
                            <th data-i18n="id.th_drill_events">è»æ¼”å€äº‹ä»¶</th>
                        </tr>
                    </thead>
                    <tbody id="freqTableBody">
                        <tr><td colspan="5" class="empty-msg" data-i18n="common.loading">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title" data-i18n="id.timeline_title">ğŸ“‹ è®Šæ›´äº‹ä»¶æ™‚é–“è»¸</div>
            <div class="panel-body">
                <div class="timeline-scroll">
                    <table class="timeline-table">
                        <thead>
                            <tr>
                                <th data-i18n="id.th_time">æ™‚é–“</th>
                                <th data-i18n="id.th_mmsi">MMSI</th>
                                <th data-i18n="id.th_field">æ¬„ä½</th>
                                <th data-i18n="id.th_old">è®Šæ›´å‰</th>
                                <th data-i18n="id.th_new">è®Šæ›´å¾Œ</th>
                                <th data-i18n="id.th_location">ä½ç½®</th>
                            </tr>
                        </thead>
                        <tbody id="timelineBody">
                            <tr><td colspan="6" class="empty-msg" data-i18n="common.loading">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="update-info" id="updateInfo" data-i18n="common.update_time">è³‡æ–™æ›´æ–°æ™‚é–“: --</div>

    <footer class="site-footer">
        <p>Contact: <a href="mailto:s0914712@gmail.com">s0914712@gmail.com</a></p>
    </footer>

    <!-- JavaScript -->
    <script src="js/i18n.js"></script>
    <script src="js/map.js"></script>
    <script src="js/charts.js"></script>
    <script>
        let map;

        function initMap() {
            map = L.map('map', {
                center: [24.0, 121.0],
                zoom: 6,
                zoomControl: true,
                attributionControl: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 18,
                opacity: 0.9
            }).addTo(map);

            // Taiwan outline
            const taiwanOutline = [
                [25.3, 121.0], [25.13, 121.5], [24.85, 121.82], [24.5, 121.8],
                [24.0, 121.5], [23.5, 121.3], [23.0, 121.0], [22.5, 120.85],
                [22.0, 120.75], [21.9, 120.85], [22.0, 120.45], [22.3, 120.25],
                [22.6, 120.3], [23.0, 120.1], [23.5, 120.05], [24.0, 120.2],
                [24.5, 120.5], [25.0, 121.0], [25.3, 121.0]
            ];
            L.polygon(taiwanOutline, {
                color: '#4a90d9', weight: 2, opacity: 0.5,
                fillColor: '#1a3a5c', fillOpacity: 0.3
            }).addTo(map);
        }

        function timeAgo(isoStr) {
            try {
                const diff = Date.now() - new Date(isoStr).getTime();
                const hours = Math.floor(diff / 3600000);
                if (hours < 1) return i18n.t('idx.identity_just_now');
                if (hours < 24) return i18n.t('idx.identity_ago_h').replace('{0}', hours);
                const days = Math.floor(hours / 24);
                return i18n.t('idx.identity_ago_d').replace('{0}', days);
            } catch (_) { return '--'; }
        }

        function fieldBadge(field) {
            const labels = { name: i18n.t('idx.identity_name'), call_sign: i18n.t('idx.identity_callsign'), imo: i18n.t('idx.identity_imo') };
            return `<span class="field-badge field-${field}">${labels[field] || field}</span>`;
        }

        function plotEventsOnMap(events) {
            events.forEach(ev => {
                if (ev.lat == null || ev.lon == null) return;

                let color = '#00f5ff';  // default cyan
                if (ev.in_drill_zone) color = '#ff3366';  // red for drill zone
                else if (ev.multi_field) color = '#ff6b35';  // orange for multi-field

                const changes = (ev.changes || []).map(c =>
                    `${fieldBadge(c.field)} ${c.old} â†’ ${c.new}`
                ).join('<br>');

                const drillBadge = ev.in_drill_zone
                    ? `<span class="risk-badge risk-critical" style="font-size:8px">${i18n.t('idx.identity_in_drill')}</span> `
                    : '';

                L.circleMarker([ev.lat, ev.lon], {
                    radius: 5,
                    fillColor: color,
                    color: color,
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                }).addTo(map).bindPopup(
                    `<b style="color:${color}">MMSI ${ev.mmsi}</b> ${drillBadge}<br>` +
                    `<span style="font-size:10px;color:#888">${new Date(ev.timestamp).toLocaleString()}</span><br>` +
                    changes
                );
            });
        }

        function renderFreqTable(ranked, identityState) {
            const tbody = document.getElementById('freqTableBody');
            if (ranked.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="empty-msg">${i18n.t('id.no_events')}</td></tr>`;
                return;
            }

            tbody.innerHTML = ranked.slice(0, 50).map(r => {
                const state = identityState[r.mmsi] || {};
                const name = state.name || r.lastName || r.mmsi;
                const drillCell = r.drillCount > 0
                    ? `<span class="risk-badge risk-critical" style="font-size:8px">${r.drillCount}</span>`
                    : '0';
                const countColor = r.count >= 5 ? 'var(--accent-red)' : r.count >= 3 ? 'var(--accent-orange)' : 'var(--accent-cyan)';

                return `
                    <tr onclick="map.setView([${r.lastLat || 24}, ${r.lastLon || 121}], 8)">
                        <td style="color:var(--accent-cyan)">${r.mmsi}</td>
                        <td>${(name || '').substring(0, 16)}</td>
                        <td style="color:${countColor};font-weight:700">${r.count}</td>
                        <td>${timeAgo(r.lastTime)}</td>
                        <td>${drillCell}</td>
                    </tr>`;
            }).join('');
        }

        function renderTimeline(events) {
            const tbody = document.getElementById('timelineBody');
            if (events.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-msg">${i18n.t('id.no_events')}</td></tr>`;
                return;
            }

            // Flatten: one row per field change
            const rows = [];
            const sorted = [...events].sort((a, b) => b.timestamp.localeCompare(a.timestamp));
            sorted.forEach(ev => {
                (ev.changes || []).forEach(ch => {
                    rows.push({ ...ev, field: ch.field, old: ch.old, new: ch.new });
                });
            });

            tbody.innerHTML = rows.slice(0, 200).map(r => {
                const drillBadge = r.in_drill_zone
                    ? `<span class="risk-badge risk-critical" style="font-size:7px">${i18n.t('idx.identity_in_drill')}</span>`
                    : '';
                const loc = (r.lat != null && r.lon != null)
                    ? `${r.lat.toFixed(2)}, ${r.lon.toFixed(2)} ${drillBadge}`
                    : '--';

                return `
                    <tr>
                        <td>${timeAgo(r.timestamp)}</td>
                        <td style="color:var(--accent-cyan)">${r.mmsi}</td>
                        <td>${fieldBadge(r.field)}</td>
                        <td style="color:var(--text-secondary)">${(r.old || '').substring(0, 16)}</td>
                        <td style="color:var(--accent-green)">${(r.new || '').substring(0, 16)}</td>
                        <td>${loc}</td>
                    </tr>`;
            }).join('');
        }

        async function loadData() {
            try {
                // Load full identity events
                let events = [];
                try {
                    const evRes = await fetch('identity_events.json?' + Date.now());
                    if (evRes.ok) events = await evRes.json();
                } catch (_) { /* no events file yet */ }

                // Load dashboard data for identity state
                let identityState = {};
                try {
                    const stateRes = await fetch('data.json?' + Date.now());
                    if (stateRes.ok) {
                        const data = await stateRes.json();
                        // Use summary from dashboard
                        const idData = data.identity_events || {};
                        const summary = idData.summary || {};
                        document.getElementById('stat7d').textContent = summary.count_7d || 0;
                        document.getElementById('stat24h').textContent = summary.count_24h || 0;
                        document.getElementById('updateInfo').textContent =
                            i18n.t('common.updated') + ' ' + new Date(data.updated_at).toLocaleString();
                    }
                } catch (_) {}

                // Overall stats
                document.getElementById('statTotal').textContent = events.length;
                const uniqueMmsi = new Set(events.map(e => e.mmsi));
                document.getElementById('statVessels').textContent = uniqueMmsi.size;

                if (events.length === 0) {
                    document.getElementById('freqTableBody').innerHTML =
                        `<tr><td colspan="5" class="empty-msg">${i18n.t('id.no_events')}</td></tr>`;
                    document.getElementById('timelineBody').innerHTML =
                        `<tr><td colspan="6" class="empty-msg">${i18n.t('id.no_events')}</td></tr>`;
                    document.getElementById('dataStatus').textContent = i18n.t('id.no_events').substring(0, 30);
                    return;
                }

                // Aggregate per vessel
                const byMmsi = {};
                events.forEach(ev => {
                    if (!byMmsi[ev.mmsi]) {
                        byMmsi[ev.mmsi] = { events: [], drillCount: 0, lastTime: '', lastLat: null, lastLon: null, lastName: '' };
                    }
                    const entry = byMmsi[ev.mmsi];
                    entry.events.push(ev);
                    if (ev.in_drill_zone) entry.drillCount++;
                    if (!entry.lastTime || ev.timestamp > entry.lastTime) {
                        entry.lastTime = ev.timestamp;
                        entry.lastLat = ev.lat;
                        entry.lastLon = ev.lon;
                        // Get latest name from changes
                        const nameChange = (ev.changes || []).find(c => c.field === 'name');
                        if (nameChange) entry.lastName = nameChange.new;
                    }
                });

                const ranked = Object.entries(byMmsi)
                    .map(([mmsi, d]) => ({
                        mmsi,
                        count: d.events.length,
                        drillCount: d.drillCount,
                        lastTime: d.lastTime,
                        lastLat: d.lastLat,
                        lastLon: d.lastLon,
                        lastName: d.lastName,
                    }))
                    .sort((a, b) => b.count - a.count);

                // Render
                plotEventsOnMap(events);
                renderFreqTable(ranked, {});
                renderTimeline(events);

                document.getElementById('dataStatus').textContent =
                    `âœ… ${events.length} ${i18n.t('id.total_events').toLowerCase()}`;

            } catch (e) {
                console.error('Load failed:', e);
                document.getElementById('dataStatus').textContent = i18n.t('common.error_load');
            }
        }

        // Initialize
        initMap();
        loadData();
    </script>
</body>

</html>
