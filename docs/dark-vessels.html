<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æš—èˆ¹åµæ¸¬ | Dark Vessel Detection - Taiwan Gray Zone Monitor</title>
    <meta name="description" content="SAR åˆæˆå­”å¾‘é›·é”è¡›æ˜Ÿåµæ¸¬å°ç£æµ·å³½å‘¨é‚Šç„¡ AIS è¨Šè™Ÿçš„æš—èˆ¹åˆ†å¸ƒã€å€åŸŸæ¯”è¼ƒèˆ‡æ¯æ—¥è¶¨å‹¢åˆ†æ">
    <meta name="keywords" content="æš—èˆ¹,dark vessel,SAR,åˆæˆå­”å¾‘é›·é”,AIS,å°ç£æµ·å³½,Taiwan Strait,è¡›æ˜Ÿåµæ¸¬,maritime surveillance">
    <meta name="author" content="Taiwan Gray Zone Monitor">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://s0914712.github.io/taiwan-grayzone-monitor/dark-vessels.html">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="æš—èˆ¹åµæ¸¬ | Dark Vessel Detection">
    <meta property="og:description" content="SAR åˆæˆå­”å¾‘é›·é”è¡›æ˜Ÿåµæ¸¬å°ç£æµ·å³½å‘¨é‚Šç„¡ AIS è¨Šè™Ÿçš„æš—èˆ¹åˆ†å¸ƒèˆ‡è¶¨å‹¢åˆ†æ">
    <meta property="og:url" content="https://s0914712.github.io/taiwan-grayzone-monitor/dark-vessels.html">
    <meta property="og:site_name" content="Taiwan Gray Zone Monitor">
    <meta property="og:locale" content="zh_TW">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="æš—èˆ¹åµæ¸¬ | Dark Vessel Detection">
    <meta name="twitter:description" content="SAR åˆæˆå­”å¾‘é›·é”è¡›æ˜Ÿåµæ¸¬å°ç£æµ·å³½å‘¨é‚Šç„¡ AIS è¨Šè™Ÿçš„æš—èˆ¹åˆ†å¸ƒèˆ‡è¶¨å‹¢åˆ†æ">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&family=Orbitron:wght@400;700;900&display=swap"
        rel="stylesheet">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/main.css">

    <style>
        body {
            overflow-y: auto;
        }

        #map {
            height: 400px;
            border-radius: 0 0 6px 6px;
        }
    </style>
</head>

<body>
    <header class="header">
        <h1>ğŸ”¦ æš—èˆ¹åµæ¸¬ Dark Vessel Detection</h1>
        <div class="header-nav">
            <a href="index.html">ç°è‰²åœ°å¸¶ç›£æ¸¬</a>
            <a href="dark-vessels.html" class="active">æš—èˆ¹åµæ¸¬</a>
            <a href="statistics.html">çµ±è¨ˆåˆ†æ</a>
            <span class="data-status" id="dataStatus">è¼‰å…¥ä¸­...</span>
        </div>
    </header>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="value" id="statTotal">--</div>
            <div class="label">SAR ç¸½åµæ¸¬æ•¸</div>
        </div>
        <div class="stat-card">
            <div class="value alert" id="statDark">--</div>
            <div class="label">æš—èˆ¹æ•¸é‡</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statMatched">--</div>
            <div class="label">æœ‰ AIS åŒ¹é…</div>
        </div>
        <div class="stat-card">
            <div class="value alert" id="statRatio">--%</div>
            <div class="label">æš—èˆ¹æ¯”ä¾‹</div>
        </div>
    </div>

    <div class="main-content">
        <!-- æš—èˆ¹åœ°åœ– -->
        <div class="panel map-panel">
            <div class="panel-title">ğŸ“ æš—èˆ¹ä½ç½®åˆ†å¸ƒï¼ˆSAR è¡›æ˜Ÿåµæ¸¬ã€ç„¡ AIS åŒ¹é…ï¼‰</div>
            <div id="map"></div>
        </div>

        <!-- æ¯æ—¥æš—èˆ¹æ•¸é‡åœ–è¡¨ -->
        <div class="panel chart-panel">
            <div class="panel-title">ğŸ“Š æ¯æ—¥æš—èˆ¹æ•¸é‡è¶¨å‹¢</div>
            <div class="chart-container">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>

        <!-- å€åŸŸæ¯”è¼ƒè¡¨ -->
        <div class="panel">
            <div class="panel-title">ğŸ—ºï¸ å„å€åŸŸæš—èˆ¹æ¯”è¼ƒ</div>
            <div class="panel-body">
                <table class="region-table" id="regionTable">
                    <thead>
                        <tr>
                            <th>å€åŸŸ</th>
                            <th>ç¸½åµæ¸¬</th>
                            <th>æš—èˆ¹</th>
                            <th>æ¯”ä¾‹</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="regionTableBody">
                        <tr>
                            <td colspan="5" class="empty-state">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æœ‰ AIS èˆ¹éš»åœ‹æ——åˆ†å¸ƒ -->
        <div class="panel">
            <div class="panel-title">ğŸš© æœ‰ AIS èˆ¹éš»åœ‹æ——åˆ†å¸ƒï¼ˆå°ç£æµ·å³½ï¼‰</div>
            <div class="panel-body">
                <div class="flag-list" id="flagList">
                    <div class="empty-state">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="update-info" id="updateInfo">è³‡æ–™æ›´æ–°æ™‚é–“: --</div>

    <footer class="site-footer">
        <p>Contact: <a href="mailto:s0914712@gmail.com">s0914712@gmail.com</a></p>
    </footer>

    <!-- JavaScript -->
    <script src="js/map.js"></script>
    <script src="js/charts.js"></script>
    <script>
        let map;

        // Region bounds for dark vessel page
        const REGION_BOUNDS = {
            taiwan_strait: [[23.5, 118.0], [23.5, 122.0], [26.5, 122.0], [26.5, 118.0]],
            east_taiwan: [[22.0, 121.5], [22.0, 124.0], [25.5, 124.0], [25.5, 121.5]],
            south_china_sea: [[18.0, 110.0], [18.0, 118.0], [23.0, 118.0], [23.0, 110.0]],
            east_china_sea: [[26.0, 122.0], [26.0, 128.0], [32.0, 128.0], [32.0, 122.0]]
        };

        function initMap() {
            map = L.map('map', {
                center: [24.0, 121.0],
                zoom: 6,
                zoomControl: true,
                attributionControl: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 18,
                opacity: 0.9
            }).addTo(map);

            // Taiwan outline
            const taiwanOutline = [
                [25.3, 121.0], [25.13, 121.5], [24.85, 121.82], [24.5, 121.8],
                [24.0, 121.5], [23.5, 121.3], [23.0, 121.0], [22.5, 120.85],
                [22.0, 120.75], [21.9, 120.85], [22.0, 120.45], [22.3, 120.25],
                [22.6, 120.3], [23.0, 120.1], [23.5, 120.05], [24.0, 120.2],
                [24.5, 120.5], [25.0, 121.0], [25.3, 121.0]
            ];
            L.polygon(taiwanOutline, {
                color: '#4a90d9', weight: 2, opacity: 0.5,
                fillColor: '#1a3a5c', fillOpacity: 0.3
            }).addTo(map);

            // Region boundaries
            Object.entries(REGION_BOUNDS).forEach(([key, coords]) => {
                L.polygon(coords, {
                    color: MapModule.REGION_COLORS[key] || '#00f5ff',
                    weight: 1.5,
                    opacity: 0.5,
                    fillOpacity: 0.03,
                    dashArray: '6,4'
                }).addTo(map);
            });
        }

        function plotDarkVessels(regions) {
            Object.entries(regions).forEach(([regionId, regionData]) => {
                const color = MapModule.REGION_COLORS[regionId] || '#ff3366';
                const details = regionData.dark_details || [];

                details.forEach(d => {
                    if (d.lat && d.lon) {
                        L.circleMarker([d.lat, d.lon], {
                            radius: 4,
                            fillColor: '#ff3366',
                            color: color,
                            weight: 1,
                            opacity: 0.8,
                            fillOpacity: 0.6
                        }).addTo(map).bindPopup(`
                            <b style="color:#ff3366">æš—èˆ¹åµæ¸¬</b><br>
                            å€åŸŸ: ${regionData.name || regionId}<br>
                            æ—¥æœŸ: ${d.date}<br>
                            ä½ç½®: ${d.lat.toFixed(3)}, ${d.lon.toFixed(3)}
                        `);
                    }
                });
            });
        }

        function renderRegionTable(regions) {
            const tbody = document.getElementById('regionTableBody');
            const rows = Object.entries(regions).map(([key, r]) => {
                const barWidth = Math.max(2, Math.min(100, r.dark_ratio));
                const color = MapModule.REGION_COLORS[key] || '#ff3366';
                return `
                    <tr>
                        <td style="color:${color};font-weight:500">${r.name || key}</td>
                        <td>${r.total_detections}</td>
                        <td style="color:var(--accent-red);font-weight:600">${r.dark_vessels}</td>
                        <td>${r.dark_ratio}%</td>
                        <td><span class="ratio-bar" style="width:${barWidth}px"></span></td>
                    </tr>`;
            });
            tbody.innerHTML = rows.join('') || '<tr><td colspan="5" class="empty-state">ç„¡è³‡æ–™</td></tr>';
        }

        function renderFlagList(regions) {
            const flagList = document.getElementById('flagList');
            const straitData = regions.taiwan_strait;
            if (!straitData || !straitData.matched_by_flag) {
                flagList.innerHTML = '<div class="empty-state">ç„¡è³‡æ–™</div>';
                return;
            }

            const flags = Object.entries(straitData.matched_by_flag).slice(0, 15);
            flagList.innerHTML = flags.map(([flag, count]) => `
                <div class="flag-item">
                    <span>${flag}</span>
                    <span style="color:var(--accent-cyan);font-family:'JetBrains Mono',monospace">${count}</span>
                </div>
            `).join('') || '<div class="empty-state">ç„¡è³‡æ–™</div>';
        }

        async function loadData() {
            try {
                const res = await fetch('data.json?' + Date.now());
                const data = await res.json();

                const dv = data.dark_vessels;
                if (!dv) {
                    document.getElementById('dataStatus').textContent = 'âš ï¸ å°šç„¡æš—èˆ¹è³‡æ–™';
                    return;
                }

                const overall = dv.overall || {};
                const regions = dv.regions || {};

                // Update stats
                document.getElementById('statTotal').textContent = (overall.total_detections || 0).toLocaleString();
                document.getElementById('statDark').textContent = (overall.dark_vessels || 0).toLocaleString();
                document.getElementById('statMatched').textContent =
                    ((overall.total_detections || 0) - (overall.dark_vessels || 0)).toLocaleString();
                document.getElementById('statRatio').textContent = (overall.dark_ratio || 0) + '%';

                // Plot dark vessels
                plotDarkVessels(regions);

                // Daily chart
                if (overall.dark_by_date && Object.keys(overall.dark_by_date).length > 0) {
                    ChartsModule.renderDailyChart('dailyChart', overall.dark_by_date);
                }

                // Region table
                renderRegionTable(regions);

                // Flag list
                renderFlagList(regions);

                // Update status
                const range = dv.data_range || {};
                document.getElementById('dataStatus').textContent =
                    `âœ… ${range.start || ''} ~ ${range.end || ''}`;
                document.getElementById('updateInfo').textContent =
                    'æ›´æ–°: ' + new Date(dv.updated_at).toLocaleString('zh-TW');

            } catch (e) {
                console.error('è¼‰å…¥å¤±æ•—:', e);
                document.getElementById('dataStatus').textContent = 'âŒ è³‡æ–™è¼‰å…¥å¤±æ•—';
            }
        }

        // Initialize
        initMap();
        loadData();
    </script>
</body>

</html>